<script>
  document.addEventListener('DOMContentLoaded', function () {
    setDefaultDateTime();
    initializeReportFilters();
    document
      .getElementById('open-excel')
      ?.addEventListener('click', openSpreadsheet);
  });

  let currentReports = [];
  let currentFilters = {};

  function setDefaultDateTime() {
    const today = new Date();
    const formattedDate = formatDateToDisplay(today);
    document.getElementById('date').value = formattedDate;

    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('startTime').value = `${hours}:${minutes}`;
  }

  function formatDateToDisplay(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function formatDateForSheet(dateString) {
    const parts = dateString.split('/');
    if (parts.length === 3) {
      return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    return dateString;
  }

  function submitForm() {
    const dateInput = document.getElementById('date').value;
    const formattedDate = formatDateForSheet(dateInput);

    var formData = {
      date: formattedDate,
      name: document.getElementById('name').value,
      department: document.getElementById('department').value,
      startTime: document.getElementById('startTime').value,
      endTime: document.getElementById('endTime').value,
      task: document.getElementById('task').value,
      notes: document.getElementById('notes').value,
      accomplishments: document.getElementById('accomplishments').value,
      challenges: document.getElementById('challenges').value,
      nextSteps: document.getElementById('plan').value,
      additionalNotes: document.getElementById('additionalNotes').value,
    };

    if (!formData.name) {
      Swal.fire({
        icon: 'error',
        title: 'Warning!',
        text: 'Please enter your name',
        confirmButtonText: 'OK',
        customClass: {
          popup: 'custom-swal-popup',
        },
      });
      return;
    }

    Swal.fire({
      title: 'Saving...',
      html: 'Please wait...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading(),
      customClass: {
        popup: 'custom-swal-popup',
      },
    });

    google.script.run
      .withSuccessHandler(function () {
        Swal.close();
        document.getElementById('workLogForm').reset();
        setDefaultDateTime();

        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Data saved successfully',
          confirmButtonText: 'OK',
          timer: 2000,
          timerProgressBar: true,
          customClass: {
            popup: 'custom-swal-popup',
          },
        }).then((result) => {
          // window.scrollTo({
          //   top: 0,
          //   behavior: 'smooth',
          // });
          initializeReportFilters();
        });
      })
      .withFailureHandler(function (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: error.message,
          confirmButtonText: 'Close',
          customClass: {
            popup: 'custom-swal-popup',
          },
          willClose: () => {
            // เมื่อกำลังจะปิด modal ให้เลื่อนขึ้นด้านบน
            window.scrollTo({
              top: 0,
              behavior: 'smooth',
            });
          },
        });
      })
      .saveData(formData);
  }

  function switchTab(tabId) {
    document
      .querySelectorAll('.tab-content')
      .forEach((tab) => tab.classList.remove('active'));
    document
      .querySelectorAll('.tab')
      .forEach((tab) => tab.classList.remove('active'));

    document.getElementById(tabId).classList.add('active');
    document
      .querySelector(`.tab[onclick*="${tabId}"]`)
      .classList.add('active');

    if (tabId === 'report-tab') loadReports();
  }

  function initializeReportFilters() {
    google.script.run
      .withSuccessHandler(function (years) {
        const yearSelect = document.getElementById('report-year');
        yearSelect.innerHTML = '<option value="">All Years</option>';
        years.forEach(
          (year) =>
            (yearSelect.innerHTML += `<option value="${year}">${year}</option>`)
        );
        yearSelect.value = new Date().getFullYear().toString();
      })
      .getAvailableYears();

    google.script.run
      .withSuccessHandler(function (names) {
        const nameSelect = document.getElementById('report-name');
        nameSelect.innerHTML = '<option value="">All Names</option>';
        names.forEach(
          (name) =>
            (nameSelect.innerHTML += `<option value="${name}">${name}</option>`)
        );
      })
      .getAvailableNames();

    document.getElementById('report-month').value = new Date().getMonth();
  }

  function loadReports() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const name = document.getElementById('report-name').value;

    currentFilters = { month, year, name };

    document.getElementById('report-results').innerHTML =
      '<p class="text-muted" style="color: var(--warning-color);">Loading reports...</p>';

    google.script.run
      .withSuccessHandler(function (reports) {
        currentReports = reports;
        displayReports(reports);
      })
      .withFailureHandler(function (error) {
        document.getElementById(
          'report-results'
        ).innerHTML = `<p class="text-muted" style="color: var(--danger-color);">Error: ${error.message}</p>`;
      })
      .getReports(month, year, name);
  }

  function displayReports(reports) {
    const resultsDiv = document.getElementById('report-results');

    if (!reports || reports.length === 0) {
      resultsDiv.innerHTML = '<p class="text-muted">No records found</p>';
      return;
    }

    google.script.run
      .withSuccessHandler(function (spreadsheetUrl) {
        let html = `
        <div style="overflow-x: auto;">
          <table class="report-table">
            <thead>
              <tr>
                <th style="width: 100px;">Date</th>
                <th style="width: 120px;">Name</th>
                <th style="width: 150px;">Department</th>
                <th>Tasks</th>
                <th style="width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody>`;

        reports.forEach((report, index) => {
          const formattedDate = formatReportDate(report.date);

          html += `
          <tr>
            <td>${formattedDate}</td>
            <td>${report.name || ''}</td>
            <td>${report.department || ''}</td>
            <td>
              <div class="task-content" style="max-height: 60px; overflow: hidden;">
                ${report.task || ''}
              </div>
              ${report.task && report.task.length > 100
              ? '<button class="show-more-btn" onclick="toggleTask(this)">Show more</button>'
              : ''
            }
            </td>
            <td style="text-align: center;">
              <button class="action-btn edit-btn" onclick="editReport(${index})" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete-btn" onclick="deleteReport(${index})" title="Delete">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>`;
        });

        html += `</tbody></table>
          <p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
            Showing ${reports.length} records
          </p>
        </div>`;

        resultsDiv.innerHTML = html;
      })
      .getSpreadsheetUrl();
  }

  function formatTimeForInput(timeValue) {
    if (!timeValue && timeValue !== 0) return '';

    if (typeof timeValue === 'string') {
      if (timeValue.includes(':')) {
        const parts = timeValue.split(':');
        return `${parts[0].padStart(2, '0')}:${parts[1] || '00'}`;
      }
      return '';
    }

    if (typeof timeValue === 'number') {
      const totalMinutes = Math.round(timeValue * 24 * 60);
      const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
      const minutes = (totalMinutes % 60).toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    return '';
  }

  function editReport(index) {
    const report = currentReports[index];

    if (!report) {
      console.error('No report found at index:', index);
      Swal.fire('Error', 'Report not found', 'error');
      return;
    }

    console.log('report:', report);

    // ฟังก์ชันสำหรับจัดรูปแบบเวลา
    const formatTimeForInput = (timeValue) => {
      if (!timeValue && timeValue !== 0) return '';

      if (typeof timeValue === 'string') {
        if (timeValue.includes(':')) {
          const parts = timeValue.split(':');
          return `${parts[0].padStart(2, '0')}:${parts[1] || '00'}`;
        }
        return '';
      }

      if (typeof timeValue === 'number') {
        const totalMinutes = Math.round(timeValue * 24 * 60);
        const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
        const minutes = (totalMinutes % 60).toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      return '';
    };

    Swal.fire({
      title: 'Edit Report',
      html: `
      <div class="form-group">
        <label>Date:</label>
        <input type="text" class="swal2-input" value="${formatReportDate(report.date)}" disabled>
      </div>
      <div class="form-group">
        <label for="edit-name">Name:</label>
        <input type="text" id="edit-name" class="swal2-input" value="${report.name || ''}">
      </div>
      <div class="form-group">
        <label for="edit-department">Department:</label>
        <input type="text" id="edit-department" class="swal2-input" value="${report.department || ''}">
      </div>
      <div class="form-group">
        <label for="edit-startTime">Start Time:</label>
        <input type="time" id="edit-startTime" class="swal2-input" value="${report.starttime}  || ''">
      </div>
      <div class="form-group">
        <label for="edit-endTime">End Time:</label>
        <input type="time" id="edit-endTime" class="swal2-input" value="${report.endtime}  || ''">
      </div>
      <div class="form-group">
        <label for="edit-task">Task/Activity:</label>
        <textarea id="edit-task" class="swal2-textarea">${report.task || ''}</textarea>
      </div>
      <div class="form-group">
        <label for="edit-notes">Notes/Progress/Challenges:</label>
        <textarea id="edit-notes" class="swal2-textarea">${report.notes || ''}</textarea>
      </div>
      <div class="form-group">
        <label for="edit-accomplishments">Key Accomplishments:</label>
        <textarea id="edit-accomplishments" class="swal2-textarea">${report.accomplishments || ''}</textarea>
      </div>
      <div class="form-group">
        <label for="edit-challenges">Challenges/Roadblocks:</label>
        <textarea id="edit-challenges" class="swal2-textarea">${report.challenges || ''}</textarea>
      </div>
      <div class="form-group">
        <label for="edit-plan">Plan for Tomorrow/Next Steps:</label>
        <textarea id="edit-plan" class="swal2-textarea">${report.nextsteps || ''}</textarea>
      </div>
      <div class="form-group">
        <label for="edit-additionalNotes">Additional Notes:</label>
        <textarea id="edit-additionalNotes" class="swal2-textarea">${report.additionalnotes || ''}</textarea>
      </div>
      <input type="hidden" id="edit-sheetName" value="${report.sheetName || ''}">
      <input type="hidden" id="edit-rowNumber" value="${report.rowNumber || ''}">
    `,
      width: '700px',
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'Save',
      cancelButtonText: 'Cancel',
      customClass: {
        popup: 'custom-swal-popup',
        header: 'custom-swal-header',
        title: 'custom-swal-title',
        content: 'custom-swal-content',
        actions: 'custom-swal-actions',
        confirmButton: 'custom-swal-confirm-btn',
        cancelButton: 'custom-swal-cancel-btn'
      },
      preConfirm: () => {
        return {
          sheetName: document.getElementById('edit-sheetName').value,
          rowNumber: parseInt(document.getElementById('edit-rowNumber').value),
          date: report.date, // ใช้ date เดิมจาก report
          name: document.getElementById('edit-name').value,
          department: document.getElementById('edit-department').value,
          startTime: document.getElementById('edit-startTime').value,
          endTime: document.getElementById('edit-endTime').value,
          task: document.getElementById('edit-task').value,
          notes: document.getElementById('edit-notes').value,
          accomplishments: document.getElementById('edit-accomplishments').value,
          challenges: document.getElementById('edit-challenges').value,
          nextSteps: document.getElementById('edit-plan').value,
          additionalNotes: document.getElementById('edit-additionalNotes').value
        };
      }
    }).then((result) => {
      if (result.isConfirmed) {
        const updatedData = result.value;

        Swal.fire({
          title: 'Updating...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        google.script.run
          .withSuccessHandler(() => {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Report updated successfully',
              timer: 2000
            }).then(() => loadReports());
          })
          .withFailureHandler((error) => {
            Swal.fire({
              icon: 'error',
              title: 'Error!',
              text: error.message
            });
          })
          .updateReport(
            updatedData.sheetName,
            updatedData.rowNumber,
            updatedData
          );
      }
    });
  }
  function deleteReport(index) {
    const report = currentReports[index];

    // ตรวจสอบว่ามีข้อมูล report จริงๆ
    if (!report) {
      console.error('No report found at index:', index);
      return;
    }

    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!',
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: 'Deleting...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        // ใช้ sheetName และ rowNumber จาก report โดยตรง
        google.script.run
          .withSuccessHandler(() => {
            Swal.fire(
              'Deleted!',
              'Report has been deleted.',
              'success'
            ).then(() => loadReports());
          })
          .withFailureHandler((error) => {
            Swal.fire('Error', error.message, 'error');
          })
          .deleteReport(report.sheetName, report.rowNumber);
      }
    });
  }
  function formatReportDate(dateString) {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}-${month}-${year}`;
    } catch (e) {
      return dateString;
    }
  }

  function toggleTask(button) {
    const content = button.previousElementSibling;
    if (content.style.maxHeight === '60px') {
      content.style.maxHeight = 'none';
      button.textContent = 'See Less';
    } else {
      content.style.maxHeight = '60px';
      button.textContent = 'See More';
    }
  }

  function openSpreadsheet() {
    google.script.run
      .withSuccessHandler(function (url) {
        window.open(url, '_blank');
      })
      .getSpreadsheetUrl();
  }
</script>